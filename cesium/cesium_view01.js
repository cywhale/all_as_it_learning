// run in cesium sandcastle: 
// https://sandcastle.cesium.com/#c=rVhbU9s6EP4rGl7iFCxzLZdQ5gClLTO0ZUpaZk7TYRRbTgS25EpyuJzhv5+VZDtyEkIfmuk0kbzfane1++2aCZFowug9legd4vQenVLFyhz/sHvBYCW261PBNWGcysFKtzfgE0DdU6XXkBKlHq8hSsyCC6nH1WMtRDYkRmsi4jKnXOMR1WcZNT9PHs+ToFOJdGqNMcmpJIBwBmG3hocDHkW5SFjKaIJSKXI01rpQB1E0Ygr0Mj0uhzgWeUSfnmiU7OzSvZ1dsrm3+3Z3N94fbm8Nd8hbsr21Cb82tgc8LXmsmeAooZrG+l8h8gs6oVmQgD7CY9pF/w04gk9GNVIx5XRqll32po81y+ilFBOW2CDax3iUiSHFN6qUKYkp9mU86O+SJFpSo9yXwDf1A082keSe8dFJmaZUfqJsNNZ+qCCCCo/ttgdSir6nXOSMEy3kbGhxKkul4bbbYv6hZhdgm3gdvUGfiR5jiE+wjndgOaPkJhWTx64FOwWx4EpkFGdiFLRP6PbmJQYr9rADNFhBq0t0I5SCJ4GxLjN3Btat96qfh+/Qxn61WF1tLrH2JicPH6nIqZYsPpPSBqQVd8hQmwefyQPLy7wtHFi1tRG1k7NOzJ1ROTS3P1U0E4UqBStck5G9ti+0sj+Yd+rNolzpogg16W1ETLBfsoF6htNlxtZ5inMXsasYFvyqgJz3nX9NzHeOpShwzh2+jvNv2Hwk1aXkLgE8nc/u57OhEk+Ml5mRen6FYTAELb6jD/GY8BG1PPO7BPYDAlHRxub+/vpW5Ggy3EpCQykS8hziH+oxDXNShComGQ1FajdsCSahZQggvlZB5mJCz3iCSZKcTYAoL+DCgE5k0DBWYH2OohqXifgOC95n8PUayrhuaNuwlOFt+N7f36/iZCjc9ADD4fAduifuWRSh0+Pv/fOvXw7QcQy+KvAO3RSSTYimCMibkWFGFWIKFGgk0pTFjGTZI1JlUYBKCCvhSaOt+UBA0PHlOdQ7R0NJyR0iGiQfoS5ziu6B2cFQdE+kiSd2eNteoGxVX3yj3LGuz83LyBfftJAnj336ALlAT0XJdeOvycGqESY0hb6XBC1Yt5V4xh5e5sdSkkdVUUojijPKR7Yr1uKWvgzm1lHXLSR6A++h1dXbubQ20nUtzJ3w8/ZXry2+wPwG3Z1T7rnQr/Q30vPWt7wwRMScF8x5YTUYJ9jCc+qzJHRdKKaM+of9ZL9w86C3GFylr+1EUGSBm0IaFDbr7gvYOucbcDW8TNF24yV4VSAOTR4CN/NMwWb9ErauqgZsN3y03VgEf25vPb/MaiawKpZEx+NvXny9qa7ZDuqT6suYGw2A5YpSUzMHTlELqoxmGSuUYMna1LBZI/zDCqHmzoI9ZmiqV/ODmwaBNRQDXpip7gKo7rJCBAD1tRuQGElSjFkMuMrtU28XG3Y/rXX7+Omx8xrOai/x9cervW3cGNcXvvJZc8b1mOZrbU9pUVR3GttlgP9lmon72S6zs7W1sbWzF+kxVEp4q0IYVUIxvIUQh4o90dBQZSipKsyOFqELbQikW4vVUQ7hn7KN1Knd29uZWjz58PWHtbc1fsH0VY9/wNUR2tiDiq8+wOYwE4DZGpn/GLQ6ZOS1QJIkECLlaW8CsumPk+7UCDa7sN0Kj0HVY97ssO4E29cHTdyMbzAMPUxvry/BCiCsXNki/WJK7XvRFx/YA00+SPB19uKG0A4S6DhXxZjKmSI6aT0L2ueD3MksdiEO69qoa9fkrsyMELQPXvP9aVURWJ5dwb1P7woS4rLenVPTKqDWdHjNEkNELwt8molyRQyG7IfQekXqjFHQyqF1C8lGMONnyPECRaQoKJHKpIMZd6aRMll7zi8dFuZYkxGN2Zc2RCZ/SmUm18Zf7/XCdDnbDo7Q/vp6q91Ub5aYcZiCPvU/X8ABnQsREzsMmQnljot7jjuVV89gLti6XEObhzvXcPQB6sB0W92vS2fxno5MM7OmdWFtkyzY7oJg53AooyOAzKi6Mm1nmS7Xl/5M2RlZbpdtU3+myhbKMl2uaf2ZstzMxQoVtMpep3eayB4S+dAo6vip4mCt5PGRaObUmvSq04R68RwQdoTiRCumWiI98cUnr8s/AXE5LnMQR2tLAGFoy9L25wMUhp1lwq+lo1GC/2ZOWoV/MzGtwr+ZnVbhXIr2UDM2PRtWW1lbOVT6MaNHtf5/WG5eWVApswDjSNO8yOA1R0XDEl4DNY5V0ysOIx96mLAJYsm7BX81Q3FGlIInKbxzmnwfrBwdRiA/B80EMRT4FZppRh6N2Hjj6MJtYowPI1guRlacNaP5fw
// Note that this cannot run in 2D mode to get zoom level since fov, fovy is undefined
// instead use pixelSize to infer zoom level 
// map scale vs zoom: https://docs.geoserver.org/latest/en/user/styling/ysld/reference/scalezoom.html
// a google map 2D height vs zoom: https://stackoverflow.com/questions/36544209/converting-altitude-to-z-level-and-vice-versa
// but this google map zoom seems a level + 1~2 with the following table
// map scale/pixelSize //=> zoom level
// 559082264/53132(+)  //=> 0 (ratio 10522.51)
// 279541132/47478     //=> 1 (5887.803 upper limit of zoom 1)
// 139770566/29029     //=> 2 (4814.86)
// 69885283/18927      //=> 3 (3692.359)
// 34942641/13673      //=> 4 (2555.594)
// 17471321/11191      //=> 5 (1561.194)
// 8735660/10175       //=> 6 (858.5415)
// 4367830/9600        //=> 7 (454.9823)
// 2183915/9321        //=> 8 (234.3005)

var viewer = new Cesium.Viewer("cesiumContainer");
var west, south, east, north;
var toolbar = document.getElementById('toolbar');
var camera = viewer.camera;

//modified from https://gist.github.com/ezze/d57e857a287677c9b43b5a6a43243b14
function detectZoomLevel(distance) {
    let scene = viewer.scene;
    let tileProvider = scene.globe._surface.tileProvider;
    let quadtree = tileProvider._quadtree;
    let drawingBufferHeight = viewer.canvas.height;
    let sseDenominator = viewer.camera.frustum.sseDenominator;
 // let denom = 2.0 * Math.tan(0.5 * camera.frustum._fovy);
  
//  console.log(sseDenominator);
//  console.log("denom: " + camera.frustum._fovy);
    for (let level = 0; level <= 19; level++) {
        let maxGeometricError = tileProvider.getLevelMaximumGeometricError(level);
      
//      console.log("maxGeometricError: " + maxGeometricError);
//      console.log("distance: " + distance);
        let error = (maxGeometricError * drawingBufferHeight) / (distance * denom);
//      console.log("error: " + error);
//      console.log("quadtree.maximumScreenSpaceError: " + quadtree.maximumScreenSpaceError);
        if (error < quadtree.maximumScreenSpaceError) {
            return level;
        }
    }

    return null;
}

//modified from https://gis.stackexchange.com/questions/129903/cesium-3d-determining-the-map-scale-of-the-viewed-globe
viewer.camera.moveEnd.addEventListener(function () {
//viewer.clock.onTick.addEventListener(function () {
    west = south = 999;
    east = north = -999;

    // CAUTION: Accessing _private variables is not officially supported and
    //          the API can break at any time without warning.
    var tilesToRender = viewer.scene.globe._surface.tileProvider._tilesToRenderByTextureCount;

    if (Cesium.defined(tilesToRender)) {
        var numArrays = tilesToRender.length;
        for (var j = 0; j < numArrays; ++j) {
            var quadtrees = tilesToRender[j];
            if (Cesium.defined(quadtrees)) {
                var numTrees = quadtrees.length;
                for (let i = 0; i < numTrees; ++i) {
                    var rectangle = quadtrees[i].rectangle;
                    west = Math.min(west, rectangle.west);
                    south = Math.min(south, rectangle.south);
                    east = Math.max(east, rectangle.east);
                    north = Math.max(north, rectangle.north);
                }
            }
        }
    }

    var scratchRectangle = new Cesium.Rectangle();
    var rect = viewer.camera.computeViewRectangle(viewer.scene.globe.ellipsoid,
        scratchRectangle);
    var pos = viewer.camera.position;
    //var cartesian = viewer.scene.pickPosition(pos);
    var cartographic = Cesium.Cartographic.fromCartesian(pos);
    //var cartographic = Cesium.Ellipsoid.WGS84.cartesianToCartographic(pos);
    var height = cartographic.height;
    //https://stackoverflow.com/questions/15331358/three-js-get-object-size-with-respect-to-camera-and-object-position-on-screen/15331885
    var vFOV = camera.frustum.fov * Math.PI / 180;        // convert vertical fov to radians
    var vheight = 2 * Math.tan( vFOV / 2 ) * height;
    var level = detectZoomLevel(height);
    //var modelMatrix = Cesium.Transforms.eastNorthUpToFixedFrame(pos);
    var boundingSphere = new Cesium.BoundingSphere();
    //var newBoundingSphere = Cesium.BoundingSphere.transformWithoutScale(boundingSphere, modelMatrix);
    var pixelSize = camera.getPixelSize(boundingSphere, viewer.scene.drawingBufferWidth, viewer.scene.drawingBufferHeight);
    //compute number of pixels that original ellipse appears to be
    //var sizeInPixels = (2 * boundingSPhere.radius) / pixelSize;
  
    if (west > 900) {
        toolbar.innerHTML = 'Location not known.';
    } else {
        toolbar.innerHTML =
            'West: ' + Cesium.Math.toDegrees(west).toFixed(4) + '<br/>' +
            'South: ' + Cesium.Math.toDegrees(south).toFixed(4) + '<br/>' +
            'East: ' + Cesium.Math.toDegrees(east).toFixed(4) + '<br/>' +
            'North: ' + Cesium.Math.toDegrees(north).toFixed(4) + '<br/>' +
            'meters per pixel: ' + pixelSize + '<br/>' + 
          //'sizeInPixels: ' + sizeInPixels + '<br/>' +  
            'position: ' + pos + '<br/>' + 
            'height: ' + height + '<br/>' + 
            'vheight: ' + vheight + '<br/>' + 
            'zoom level: ' + level + '<br/>' + 
            '-- view rect: --' + '<br/>' + 
            'West: ' + Cesium.Math.toDegrees(rect.west).toFixed(4) + '<br/>' +
            'South: ' + Cesium.Math.toDegrees(rect.south).toFixed(4) + '<br/>' +
            'East: ' + Cesium.Math.toDegrees(rect.east).toFixed(4) + '<br/>' +
            'North: ' + Cesium.Math.toDegrees(rect.north).toFixed(4); 
    }
});
